name: 'OVH K3s Cluster Deploy'

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
          - clean

permissions:
  contents: read

jobs:
  terraform:
    name: 'Terraform ${{ github.event.inputs.action }}'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./providers/ovh/terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: ğŸ”§ CLEAN Terraform State
        if: github.event.inputs.action != 'plan'
        run: |
          rm -rf .terraform .terraform.lock.hcl terraform.tfstate*

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        run: terraform plan -detailed-exitcode || true
        env:
          TF_VAR_ovh_endpoint: ${{ secrets.OVH_ENDPOINT }}
          TF_VAR_ovh_application_key: ${{ secrets.OVH_APPLICATION_KEY }}
          TF_VAR_ovh_application_secret: ${{ secrets.OVH_APPLICATION_SECRET }}
          TF_VAR_ovh_consumer_key: ${{ secrets.OVH_CONSUMER_KEY }}
          TF_VAR_service_name: ${{ secrets.OVH_SERVICE_NAME }}
          TF_VAR_ssh_public_key: ${{ secrets.OVH_SSH_PUBLIC_KEY }}
          TF_VAR_openstack_tenant_id: ${{ secrets.OPENSTACK_TENANT_ID }}
          TF_VAR_openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          TF_VAR_openstack_password: ${{ secrets.OPENSTACK_PASSWORD }}

      - name: ğŸš€ Terraform Apply
        if: github.event.inputs.action == 'apply'
        run: terraform apply -auto-approve
        env:
          TF_VAR_ovh_endpoint: ${{ secrets.OVH_ENDPOINT }}
          TF_VAR_ovh_application_key: ${{ secrets.OVH_APPLICATION_KEY }}
          TF_VAR_ovh_application_secret: ${{ secrets.OVH_APPLICATION_SECRET }}
          TF_VAR_ovh_consumer_key: ${{ secrets.OVH_CONSUMER_KEY }}
          TF_VAR_service_name: ${{ secrets.OVH_SERVICE_NAME }}
          TF_VAR_ssh_public_key: ${{ secrets.OVH_SSH_PUBLIC_KEY }}
          TF_VAR_openstack_tenant_id: ${{ secrets.OPENSTACK_TENANT_ID }}
          TF_VAR_openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          TF_VAR_openstack_password: ${{ secrets.OPENSTACK_PASSWORD }}

      - name: ğŸ“Š Generate Ansible Inventory AUTOMÃTICO
        if: github.event.inputs.action == 'apply'
        run: |
          echo "ğŸ¯ Generando inventario AUTOMÃTICO..."
          mkdir -p ../../ansible/inventory/
          
          # âœ… OPCIÃ“N 1: Terraform outputs (PRIMERO)
          if terraform output -raw ansible_inventory > ../../ansible/inventory/hosts.yml 2>/dev/null; then
            echo "âœ… Inventario desde Terraform outputs"
          else
            # âœ… OPCIÃ“N 2: Extraer IPs directamente del state
            echo "ğŸ” Extrayendo IPs del Terraform state..."
            mkdir -p ../../ansible/inventory/
            cat > ../../ansible/inventory/hosts.yml << 'EOF'
all:
  vars:
    ansible_user: ubuntu
    ansible_ssh_private_key_file: ~/.ssh/id_rsa
  children:
    k3s_masters:
      hosts: {}
    k3s_workers:
      hosts: {}
EOF
            
            # Extraer masters
            MASTERS=$(terraform show -json | jq -r '.values.root_module.resources[] | select(.type=="openstack_compute_instance_v2" and .name=="k3s_master") | .values.access_ip_v4 // empty')
            for ip in $MASTERS; do
              if [ ! -z "$ip" ]; then
                yq e ".all.children.k3s_masters.hosts.\"k3s-master-$(echo $ip | cut -d. -f4)\".ansible_host = \"$ip\"" -i ../../ansible/inventory/hosts.yml
              fi
            done
            
            # Extraer workers (si existen)
            WORKERS=$(terraform show -json | jq -r '.values.root_module.resources[] | select(.type=="openstack_compute_instance_v2" and .name=="k3s_worker") | .values.access_ip_v4 // empty')
            for ip in $WORKERS; do
              if [ ! -z "$ip" ]; then
                yq e ".all.children.k3s_workers.hosts.\"k3s-worker-$(echo $ip | cut -d. -f4)\".ansible_host = \"$ip\"" -i ../../ansible/inventory/hosts.yml
              fi
            done
          fi
          
          echo "ğŸ“‹ Inventario generado:"
          cat ../../ansible/inventory/hosts.yml
        env:
          TF_VAR_ovh_endpoint: ${{ secrets.OVH_ENDPOINT }}
          TF_VAR_ovh_application_key: ${{ secrets.OVH_APPLICATION_KEY }}
          TF_VAR_ovh_application_secret: ${{ secrets.OVH_APPLICATION_SECRET }}
          TF_VAR_ovh_consumer_key: ${{ secrets.OVH_CONSUMER_KEY }}
          TF_VAR_service_name: ${{ secrets.OVH_SERVICE_NAME }}
          TF_VAR_ssh_public_key: ${{ secrets.OVH_SSH_PUBLIC_KEY }}
          TF_VAR_openstack_tenant_id: ${{ secrets.OPENSTACK_TENANT_ID }}
          TF_VAR_openstack_username: ${{ secrets.OPENSTACK_USERNAME }}
          TF_VAR_openstack_password: ${{ secrets.OPENSTACK_PASSWORD }}

      - name: ğŸ“¦ Upload Ansible Inventory
        if: github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: ansible-inventory
          path: providers/ovh/ansible/inventory/

      - name: ğŸ’¥ Destroy/Clean
        if: github.event.inputs.action == 'destroy' || github.event.inputs.action == 'clean'
        run: |
          terraform destroy -auto-approve || true
          rm -rf .terraform*

  ansible:
    name: 'ğŸš€ Configure K3s Cluster'
    needs: terraform
    if: github.event.inputs.action == 'apply'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./providers/ovh/ansible

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Inventory
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ansible-inventory
          path: inventory/

      - name: ğŸ” Verify Inventory
        run: |
          if [ ! -f "inventory/hosts.yml" ]; then
            echo "âŒ No inventory found - creating minimal"
            mkdir -p inventory
            cat > inventory/hosts.yml << EOF
all:
  children:
    k3s_masters:
      hosts: {}
EOF
          fi
          echo "ğŸ“‹ Inventory:"
          cat inventory/hosts.yml

      - name: ğŸ› ï¸ Install Ansible + yq
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible sshpass jq yq

      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OVH_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: ğŸŒ Add known_hosts
        run: |
          ansible-inventory -i inventory/hosts.yml --list | jq -r '.all.children.k3s_masters.hosts | keys[] | .ansible_host' | while read ip; do
            ssh-keyscan -H $ip >> ~/.ssh/known_hosts 2>/dev/null || true
          done

      - name: â³ Wait instances (5min)
        run: sleep 300

      - name: ğŸš€ Install K3s
        run: ansible-playbook -i inventory/hosts.yml playbooks/k3s-install.yml || echo "K3s via cloud-init OK"

      - name: âš™ï¸ Configure cluster  
        run: ansible-playbook -i inventory/hosts.yml playbooks/cluster-config.yml || true

      - name: ğŸ¯ Install ArgoCD
        run: ansible-playbook -i inventory/hosts.yml playbooks/argocd-install.yml || true

      - name: âœ… Verify cluster
        run: |
          ansible all:!unreachable -i inventory/hosts.yml -m ping
          echo "ğŸ‰ K3s cluster deployment COMPLETED!"

