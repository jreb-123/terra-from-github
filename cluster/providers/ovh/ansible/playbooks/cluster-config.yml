---
- name: Verify K3s cluster
  hosts: k3s_masters[0]
  become: yes
  tasks:
    - name: Get cluster nodes
      command: kubectl get nodes -o wide
      register: nodes_output
      changed_when: false

    - name: Display nodes
      debug:
        var: nodes_output.stdout_lines

    - name: Verify all nodes are Ready
      shell: kubectl get nodes --no-headers | grep -c "Ready"
      register: ready_count
      changed_when: false

    - name: Display ready node count
      debug:
        msg: "{{ ready_count.stdout }} nodes are Ready"

    - name: Verify Traefik is NOT running
      shell: kubectl get pods -n kube-system | grep traefik || echo "Traefik not found (expected for Istio setup)"
      register: traefik_check
      changed_when: false

    - name: Show Traefik check result
      debug:
        var: traefik_check.stdout_lines
