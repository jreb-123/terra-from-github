---
- name: Bootstrap ArgoCD Applications
  hosts: k3s_masters[0]
  become: no
  gather_facts: false

  tasks:
    - name: Create ArgoCD apps directory on host
      file:
        path: /tmp/argocd-apps
        state: directory
        mode: '0755'

    - name: Copy ArgoCD Application manifests
      copy:
        src: "{{ playbook_dir }}/../../../apps/argocd-apps/"
        dest: /tmp/argocd-apps/
        mode: '0644'

    - name: Wait for ArgoCD server to be ready
      command: kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
      retries: 3
      delay: 10
      register: argocd_ready
      until: argocd_ready.rc == 0

    - name: Apply ArgoCD Application manifests
      command: kubectl apply -f /tmp/argocd-apps/
      register: apply_result

    - name: Show applied resources
      debug:
        var: apply_result.stdout_lines

    - name: Wait for applications to sync
      shell: |
        kubectl get application -n argocd -o jsonpath='{range .items[*]}{.metadata.name}={.status.sync.status} {end}'
      register: sync_status
      retries: 30
      delay: 10
      until: "'OutOfSync' not in sync_status.stdout"
      ignore_errors: true

    - name: Show ArgoCD application status
      command: kubectl get applications -n argocd -o wide
      register: app_status

    - name: Display application status
      debug:
        var: app_status.stdout_lines

    - name: Cleanup temporary files
      file:
        path: /tmp/argocd-apps
        state: absent
